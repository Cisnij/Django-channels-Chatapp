<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Chat</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq" crossorigin="anonymous"></script>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.4.2/mdb.min.css" rel="stylesheet" />
        <style>
            #friend-requests-box {
              position: fixed;
              top: 0;
              right: -350px; /* ·∫®n ngo√†i m√†n h√¨nh */
              width: 300px;
              height: 100%;
              background-color: white;
              box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
              border-left: 1px solid #ddd;
              transition: right 0.3s ease;
              z-index: 1050;
              padding: 20px;
              overflow-y: auto;
            }

            #friend-requests-box.show {
              right: 0; /* Khi hi·ªán ra */
            }

            .close-btn {
              position: absolute;
              top: 10px;
              left: 10px;
              cursor: pointer;
              font-size: 18px;
              font-weight: bold;
              color: red;
            }
</style>

    </head>

  <body>

      <div id="friend-requests-box" style="background: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 300px;">
        <span class="close-btn" id="close-friend-box" style="float: right; cursor: pointer;">&times;</span>
        <h5 class="mb-3">L·ªùi m·ªùi k·∫øt b·∫°n</h5>

        <!-- üîΩ Form Add Friend -->
        <form action="{% url 'addfriend' %}" method="POST" class="d-flex mb-3 myform">
          {% csrf_token %}
          <input type="text" name="search" class="form-control form-control-sm me-2" placeholder="Nh·∫≠p id..." required>
          <button type="submit" id="button-add" class="btn btn-sm btn-success">Add</button>
        </form>

        <hr>
      <div id="add-friend-message-area" class="mess alert alert-info p-2 small">
              <p style="color:red"></p>
      </div>         
        {% for req in friend_request %}
          <div class="d-flex align-items-center mb-3">
            <img src="{{ req.sender_request.pic.url }}" alt="avatar" width="40" class="rounded-circle me-2">
            <div>
              <p class="mb-0 fw-bold">{{ req.sender_request.name }}</p>
              <small>G·ª≠i cho b·∫°n</small>    
            </div>
          </div>


          <button type="button" class="btn btn-sm btn-success btn-accept friend-action" data-action="accept" data-friend="{{req.sender_request.id}}">ƒê·ªìng √Ω</button>

          <button type="button" class="btn btn-sm btn-danger btn-reject friend-action" data-action="reject" data-friend="{{req.sender_request.id}}">T·ª´ ch·ªëi</button>
      </div>

          
        {% empty %}
          <p>Kh√¥ng c√≥ l·ªùi m·ªùi n√†o.</p>
        {% endfor %}
      </div>




      

      <section>
        <div class="container py-5">
      
          <div class="row">
            
            <div class="col-md-6 col-lg-5 col-xl-4 mb-4 mb-md-0 mx-auto">
      
              <h5 class="d-flex justify-content-between align-items-center font-weight-bold mb-3">
                <span>Account @{{ request.user.profile.name }} #id:{{user.id}}</span>
                
                <div class="d-flex align-items-center gap-3">
                  <a href="{% url 'logout' %}" class="btn btn-outline-danger btn-sm me-2">LogOut</a>
                  
                  <a href="{%url 'profile'%}">
                    <img src="https://cdn-icons-png.flaticon.com/128/880/880594.png" 
                        style="width: 30px;" alt="icon" class="img-fluid">
                  </a>

                 <button type="button" id="add-friend-icon" style="background:none; border:none; padding:0;">
                    <img src="https://cdn-icons-png.flaticon.com/128/7887/7887065.png" style="width: 30px;" alt="Add Friend">
                  </button>
                </div>
                
              </h5>
              {%for friend in friends%}
              <div class="card">
                <div class="card-body">
      
                  <ul class="list-unstyled mb-0">
                    <li class="p-2 border-bottom bg-body-tertiary">
                      <a href="{%url 'detail' friend.profile.id%}" class="d-flex justify-content-between">
                        <div class="d-flex flex-row">
                          <img src="{{friend.profile.pic.url}}" alt="avatar"
                            class="rounded-circle d-flex align-self-center me-3 shadow-1-strong" width="60">
                          <div class="pt-1">
                            <p class="fw-bold mb-0">{{friend.profile.name}}</p>
                            <p class="small text-muted"></p>
                          </div>
                        </div>
                        
                        <div class="pt-1" id="msg">
                          <p class="small text-muted mb-1" id="last-msg"></p>
                           <span class="badge bg-danger float-end noti" ></span>
                        </div>
                        
                        
                      </a>
                    </li>             
                  </ul>
      
                </div>
              </div>
              {% endfor %}
            </div>

      
          </div>
      
        </div>
      </section>
     <script>
      function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0,name.length +1)=== (name + '=')) { 
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        var csrftoken = getCookie('csrftoken');

        const url = "{% url 'acceptFriend' %}";

        // G√°n s·ª± ki·ªán cho t·∫•t c·∫£ n√∫t c√≥ class friend-action
        document.querySelectorAll('.friend-action').forEach(btn => {
          btn.addEventListener('click', handleFriendAction);
        });

        // H√†m x·ª≠ l√Ω Accept ho·∫∑c Reject
        function handleFriendAction(e) {
          e.preventDefault();  // Ch·∫∑n submit m·∫∑c ƒë·ªãnh

          const btn = e.currentTarget;
          const action = btn.dataset.action;
          const friend_id = btn.dataset.friend;

          fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({ action: action, friend_id: friend_id })
          })
          .then(res => res.json())
          .then(data => {
            console.log(data);
            
          })
          .catch(err => console.error('L·ªói fetch:', err));
        }
                
                



      const icon = document.getElementById('add-friend-icon');
      const friendBox = document.getElementById('friend-requests-box');
      const closeBtn = document.getElementById('close-friend-box');

      icon.addEventListener('click', function (e) {
        e.preventDefault();
        friendBox.classList.toggle('show');
      });

      closeBtn.addEventListener('click', function () {
        friendBox.classList.remove('show');
      });
      
      setInterval(getNotification, 1000);
      function getNotification(){
        let url="{%url 'notification'%}";
        fetch(url)
        .then(res=>res.json())
        .then(data=>{
          let noti=document.getElementsByClassName('noti');
          for(let i=0;i<data.length;i++){
            noti[i].innerText= data[i];
          }
        })
        .catch(err=>console.log(err))
      }
      
    const form = document.querySelector('.myform');

form.addEventListener('submit', function (e) {
  e.preventDefault();

  const formData = new FormData(form);

  fetch("{% url 'addfriend' %}", {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    console.log(data);
    const messBox = document.querySelector('.mess');
    messBox.innerHTML = ''; // Clear tin nh·∫Øn c≈© (n·∫øu c√≥)

    for (let i = 0; i < data.messages.length; i++) {
      messBox.innerHTML += `<p>${data.messages}</p>`;
    };
  })
  .catch(error => {
    console.error('L·ªói:', error);
  });
});


        
        

      

    
    </script>

  </body>
</html>