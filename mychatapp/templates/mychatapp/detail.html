<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Chat</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq" crossorigin="anonymous"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.4.2/mdb.min.css" rel="stylesheet" />
</head>
<style>

.chat-footer form {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  gap: 10px; /* Kho·∫£ng c√°ch gi·ªØa textarea v√† button */
}

#id_mess {
  width: 70%; /* Chi·∫øm 70% chi·ªÅu ngang */
  min-height: 45px; /* ƒê·ªß ƒë·ªÉ g√µ tho·∫£i m√°i */
  max-height: 120px; /* N·∫øu g√µ nhi·ªÅu th√¨ n√≥ c√≥ th·ªÉ l·ªõn th√™m */
  overflow-y: auto;
  resize: none; /* Kh√¥ng cho k√©o */
  padding: 10px 15px;
  border-radius: 20px;
  border: 1px solid #ccc;
  background-color: #f0f2f5;
  font-size: 14px;
  outline: none;
  box-sizing: border-box;
}

#button {
  padding: 10px 20px;
  border: none;
  border-radius: 20px;
  background-color: #0084ff;
  color: white;
  font-weight: bold;
  white-space: nowrap;
  cursor: pointer;
  transition: 0.3s;
}

#button:hover {
  background-color: #006fe6;
}


  /* C·∫≠p nh·∫≠t ƒë·ªÉ khung chat chi·∫øm 100% chi·ªÅu r·ªông */
  .chat-container {
    background-color: white;
    border-radius: 15px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    height: 80vh; /* 80% chi·ªÅu cao m√†n h√¨nh */
    width: 70%;   /* üëâ Ch·ªânh 70% chi·ªÅu r·ªông */
    margin: auto; /* üëâ Canh gi·ªØa m√†n h√¨nh */
  }

  .chat-header {
    background-color: #0084ff;
    color: white;
    padding: 10px 15px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-top-left-radius: 15px;
    border-top-right-radius: 15px;
  }

  .chat-header p {
    margin: 0;
    font-weight: bold;
  }

  /* Ph·∫ßn body ch·ª©a tin nh·∫Øn */
  .chat-body {
    padding: 10px;
    flex: 1;
    overflow-y: auto; /* Cho ph√©p cu·ªôn khi tin nh·∫Øn v∆∞·ª£t qu√° chi·ªÅu cao */
    max-height: 70%; /* Gi·ªõi h·∫°n chi·ªÅu cao c·ªßa ph·∫ßn ch·ª©a tin nh·∫Øn */
    background-color: #f7f7f8;
  }

  .message {
    display: flex;
    margin-bottom: 10px;
  }

  .message .avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    margin-right: 10px;
  }

  .message .content {
    max-width: 70%;
    padding: 8px 12px;
    border-radius: 15px;
    font-size: 14px;
  }

  /* Tin nh·∫Øn c·ªßa ng∆∞·ªùi g·ª≠i */
  .message.sent .content {
    background-color: #0084ff;
    color: white;
    margin-left: auto;
  }

  /* Tin nh·∫Øn c·ªßa ng∆∞·ªùi nh·∫≠n */
  .message.received .content {
    background-color: #e4e6eb;
    color: black;
  }

  .chat-footer {
  padding: 10px;
  background-color: white;
  display: flex;
  align-items: center;
  justify-content: space-between; /* Canh ƒë·ªÅu hai b√™n */
  border-top: 1px solid #ddd;
}



  .chat-footer input {
    border: none;
    outline: none;
    padding: 10px;
    width: 85%;
    border-radius: 20px;
    margin-right: 10px;
    background-color: #f0f2f5;
  }

  .chat-footer button {
    padding: 10px 15px;
    background-color: #0084ff;
    color: white;
    border: none;
    border-radius: 20px;
    cursor: pointer;
  }

  .chat-footer button:hover {
    background-color: #0073e6;
  }
</style>

<body>
<section>
    
    <div class="container py-5">
      <a href="{%url 'home'%}">üîô</a>
        <div class="row d-flex justify-content-center">
            <div class="col-md-12 col-lg-12 col-xl-12"> <!-- C·∫≠p nh·∫≠t ƒë·ªÉ chi·∫øm to√†n b·ªô chi·ªÅu r·ªông -->
                <div class="card chat-container">
                    <!-- Header -->
                    <div class="chat-header">                      
                        <i class="fas fa-angle-left"></i>                       
                        <p class="mb-0 fw-bold">{{friend.profile.name}}</p>
                        <i class="fas fa-times"></i>
                    </div>

                    <!-- Chat Body with Messages -->
                    <div class="chat-body" id="chat-body">
                    {% for i in message %}
                      {% if i.sender.lower != username.lower %}
                        <div class="message received">
                          <img src="{{ i.sender.profile.pic.url }}" alt="avatar" class="avatar">
                          <div class="content">
                            <p class="small mb-0">{{ i.content }}</p>
                          </div>
                        </div>    
                      {% else %}
                        <div class="message sent">
                          <div class="content">
                            <p class="small mb-0">{{ i.content }}</p>
                          </div>
                          
                        </div>
                      {% endif %}
                    {% endfor %}
                  </div>


                    <!-- Footer with input field -->
                    <div class="chat-footer">
                        <form action="" id="myform" method="POST">
                            {% csrf_token %}
                            {{ form }}
                            <button id="button" type="submit">Send</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- X·ª≠ l√Ω ƒë·ªÉ g·ª≠i tin nh·∫Øn k ph·∫£i load l·∫°i trang -->
<script>

     function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0,name.length +1)=== (name + '=')) { 
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        var csrftoken = getCookie('csrftoken');


  let form =document.getElementById('myform');
  form.addEventListener('submit',SendChat)
  function SendChat(e){
    e.preventDefault(); // NgƒÉn ch·∫∑n h√†nh ƒë·ªông load l·∫°i trang
    let chatMessage= document.getElementById('id_mess').value; // L·∫•y gi√° tr·ªã c·ªßa √¥ nh·∫≠p li·ªáu;
    var url="{% url 'sendMessage' friend.profile.id %}"
    fetch(url,{
        method:'POST',
        headers:{
            'Content-Type':'application/json',
            'X-CSRFToken':csrftoken,
        },
        body: JSON.stringify({msg: chatMessage}) // Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu th√†nh JSON
    })
    .then((response)=>{
        return response.json() //ƒê·∫©y d·ªØ li·ªáu v·ªÅ d·∫°ng json l√™n views.by t·ª´ c√°i jsonload
        })
    .then((data)=>{
         //Sau ƒë√≥ nh·∫≠n d·ªØ li·ªáu v·ªÅ t·ª´ server v√† ƒë·∫©y l√™n web
        // X·ª≠ l√Ω th√™m v√†o html ƒëo·∫°n tin nh·∫Øn      
        let chatBody= document.getElementById('chat-body')
        let ChatMessage = document.createElement("div") //t·∫°o div m∆°i 
        ChatMessage.classList.add("message", "sent") //th·ª´a k·∫ø 
        ChatMessage.innerHTML=`
        <div class="content">
            <p class="small mb-0">${data.mess}</p>  
        </div>
        <img src="${data.avatar}" alt="avatar" class="avatar">`
        chatBody.append(ChatMessage) //th√™m v√†o chatbody
        chatBody.scrollTop = chatBody.scrollHeight; // Cu·ªôn xu·ªëng d∆∞·ªõi c√πng khi c√≥ tin nh·∫Øn m·ªõi
        document.getElementById('id_mess').value =""; // X√≥a √¥ nh·∫≠p li·ªáu sau khi g·ª≠i
        
    })
  }
  let counter ={{num}};
  let msgtext="";
  setInterval(ReceiveMessage, 1000); // G·ªçi h√†m m·ªói gi√¢y

  // H√†m n√†y s·∫Ω ƒë∆∞·ª£c g·ªçi m·ªói 2 gi√¢y ƒë·ªÉ ki·ªÉm tra tin nh·∫Øn m·ªõi sau load
  function ReceiveMessage()
  {
    var url="{% url 'receiveMessage' friend.profile.id %}"
    fetch(url)
    .then((response)=>{
        return response.json()
        })
    .then((data)=>{
        if(data.message.length==0)
        {
          return;
        }
        else{
            let LastMsg= data.message[data.message.length-1];
            if(counter==data.message.length)
            {
              
              return;
            }
            else if(msgtext==LastMsg)
            {
              
              return;
            }
            else
            {     
              let chatBody= document.getElementById('chat-body')
              let ChatMessage = document.createElement("div") //t·∫°o div m∆°i 
              ChatMessage.classList.add("message", "received") //th·ª´a k·∫ø 
              ChatMessage.innerHTML=`
              <img src="${data.avatar}" alt="avatar" class="avatar">
              <div class="content">
              <p class="small mb-0"> ${LastMsg} </p>
              </div>`
              chatBody.append(ChatMessage) //th√™m v√†o chatbody
              chatBody.scrollTop = chatBody.scrollHeight; // Cu·ªôn xu·ªëng d∆∞·ªõi c√πng khi c√≥ tin nh·∫Øn m·ªõi
              document.getElementById('id_mess').value =""; // X√≥a √¥ nh·∫≠p li·ªáu sau khi g·ª≠i
              msgtext=LastMsg;
            }
            
        }
        counter = data.message.length;
        
    })

  }

  

</script>
</body>
</html>
